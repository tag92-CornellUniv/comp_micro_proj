---
title: "03_biodiversity"
author: "Ri Desroches"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path = "../figures/03_biodiversity/",
                      fig.align = "center")
```

# Set environment

```{r set-environment}
set.seed(0110)

pacman::p_load(dplyr, tidyverse, devtools, patchwork, iNEXT, phyloseq,
               install = FALSE)
```

# Load data

```{r load-data}
load("data/02_preprocessing/cleaned_physeq.RData")

min(sample_sums(nochlorosmito_physeq))

metadata_df <-
  nochlorosmito_physeq %>%
  sample_data() %>%
  data.frame()

view(metadata_df)

```

### Information about sample naming conventions in "site" column in dataframe:

- 1A Through 1F: Annually burned plots
- 2A Through 2F: Plots burned every 2 years
- 4A Through 4F: Plots burned every 4 years
- CHA Through CHF: Unburned for 60 years

1-4/CH refers to the time since a burn, or controlled unburned forests

A-F Refers to random different soil samples taken on the a plot

Metadata/sample site groupings are referred to differently in the published paper associated with this data

Editing data frame to add new metadata information:

```{r add-metadata-information}
#Information to add:
  # burn status (1 year, 2 year, 4 year, unburned)
  #separate from "sample site"
  # goal is to have a column that just has timeframe of burn without A-F sampling information

metadata_fixed_df <- metadata_df %>%
 mutate(time_frame = gsub("^CH[A-F]?$", "unburned", Site),
         time_frame = gsub("([1-4])[A-F]?$", "\\1", time_frame))

view(metadata_fixed_df)

```

Also want to prep color vector for graphing later, based on burn timeframe and sample horizon 

# Making Color vectors for graphing later

```{r color-vectors}
#color vectors based on burn time frame
timeframe_colors <- c(
  "1"="darkorange1",
  "2"="goldenrod2",
  "4"="olivedrab",
  "unburned"="darkgreen")


#color vectors based on sample horizon
sample_horizon_colors <- c(
  "A horizon"="rosybrown1",
  "B horizon"="lightsalmon3",
  "E horizon"= "darkred")

```

Ready to proceed through diversity analyses!

# Goals 

1. Hill Diversity calculations with iNEXT
2. Rarefaction curve evaluation with ggiNEXT
3. Diversity value evaluation


# iNEXT Diversity calculations

```{r iNEXT-diversity}
#input
iNEXT_input_df <-
  nochlorosmito_physeq %>%
  otu_table()%>%
  data.frame()

dim(iNEXT_input_df)
#72 Samples in df VS 35K ASVs - good

#iNEXT_data <- iNEXT(iNEXT_input_df, q=c(0,1,2), datatype="abundance")

#save 
#save(iNEXT_data, file="data/03_biodiversity/iNEXT_data.RData")
```

# Diversity Plotting

```{r diversity-plots}

#do not want to rerun inext when loading file - call previously calculated inext object/data

load("data/03_biodiversity/iNEXT_data.RData")

# Prepare colors
color_df <-
  iNEXT_input_df %>%
  colnames() %>%
  data.frame()
view(color_df)

colnames(color_df)[1]<-"names"
head(color_df) 


iNEXT_color_df<-
  color_df %>%
  left_join(., metadata_fixed_df, by="names") %>%
  
  left_join(., data.frame(timeframe_colors=timeframe_colors,
                       time_frame = names(timeframe_colors)),
            by="time_frame") %>%
  
  left_join(., data.frame(sample_horizon_colors=sample_horizon_colors,
                          horizon=names(sample_horizon_colors)),
                          by="horizon")
     
view(iNEXT_color_df)  

# Plot with ggiNEXT

ggiNEXT(iNEXT_data, type=1, facet.var = "Order.q")+
  facet_wrap(~Order.q, scales = "fixed") + 
  scale_color_manual(values = iNEXT_color_df$timeframe_colors, guide = FALSE) + 
  scale_fill_manual(values = iNEXT_color_df$timeframe_colors, guide = FALSE) + 
  scale_shape_manual(values = base::rep(17, nsamples(nochlorosmito_physeq)),
                     guide = FALSE) +
  labs(x = "Number of Sequences (Library Size)", 
       y = "Effective Number of ASVs") + 
  theme_bw() + 
  theme(legend.position = "none") 

```


This is a really busy graph - and when plotting with horizon colors it is also busy

The graph scale is also slightly thrown off by the top few samples that have a high number of ASVs


```{r diversity-plot-2}

ggiNEXT(iNEXT_data, type=1, facet.var = "Order.q")+
  facet_wrap(~Order.q, scales = "fixed") + 
  scale_color_manual(values = iNEXT_color_df$sample_horizon_colors, guide = FALSE) + 
  scale_fill_manual(values = iNEXT_color_df$sample_horizon_colors, guide = FALSE) + 
  scale_shape_manual(values = base::rep(17, nsamples(nochlorosmito_physeq)),
                     guide = FALSE) +
  labs(x = "Number of Sequences (Library Size)", 
       y = "Effective Number of ASVs") + 
  theme_bw() + 
  theme(legend.position = "none") 

```



Try manually plotting the graph to see better

# Manually plotted iNEXT data

```{r manually-plotting-iNEXT}

```

